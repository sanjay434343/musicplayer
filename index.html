<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JioSaavn Music Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .search-section {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .search-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            background: rgba(255,255,255,0.9);
            color: #333;
        }

        .search-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .preset-artists {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .preset-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .preset-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .music-section {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .artist-info {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .artist-info img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }

        .songs-grid {
            display: grid;
            gap: 15px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .song-card {
            display: flex;
            align-items: center;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .song-card:hover, .song-card.active {
            background: rgba(255,255,255,0.2);
            transform: translateX(5px);
            border-color: rgba(255,255,255,0.3);
        }

        .song-card img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            margin-right: 15px;
            object-fit: cover;
        }

        .song-info {
            flex: 1;
        }

        .song-info h4 {
            margin-bottom: 5px;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .song-info p {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .play-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            border: none;
            padding: 10px;
            border-radius: 50%;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .play-btn:hover {
            transform: scale(1.1);
        }

        .player-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .player {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .audio-visualizer {
            display: flex;
            justify-content: center;
            align-items: end;
            height: 60px;
            margin-bottom: 20px;
            gap: 3px;
        }

        .visualizer-bar {
            width: 4px;
            background: linear-gradient(to top, #ff6b6b, #ee5a52);
            border-radius: 2px;
            animation: visualize 1s ease-in-out infinite alternate;
        }

        @keyframes visualize {
            from { height: 10px; }
            to { height: 40px; }
        }

        .now-playing {
            text-align: center;
            margin-bottom: 20px;
        }

        .now-playing img {
            width: 120px;
            height: 120px;
            border-radius: 15px;
            margin-bottom: 15px;
            object-fit: cover;
        }

        .now-playing h3 {
            margin-bottom: 8px;
            font-size: 18px;
        }

        .now-playing p {
            opacity: 0.8;
            font-size: 14px;
        }

        .player-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            padding: 15px;
            border-radius: 50%;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            transform: scale(1.1);
        }

        .play-pause {
            padding: 20px;
            font-size: 24px;
        }

        .progress-section {
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            border-radius: 4px;
            width: 0%;
            transition: width 0.1s ease;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            opacity: 0.8;
        }

        .volume-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .volume-slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: rgba(255,255,255,0.2);
            outline: none;
            cursor: pointer;
        }

        .lyrics-section, .queue-section {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .lyrics-section h4, .queue-section h4 {
            margin-bottom: 15px;
            font-size: 16px;
        }

        .lyrics-content {
            max-height: 200px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.6;
        }

        .queue-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .queue-item {
            padding: 10px;
            background: rgba(255,255,255,0.1);
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .queue-item:hover {
            background: rgba(255,255,255,0.2);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            opacity: 0.8;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #ff6b6b;
            font-size: 16px;
        }

        /* Scrollbar styles */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎵 JioSaavn Music Player</h1>
            <p>Discover and play your favorite music</p>
        </div>

        <div class="search-section">
            <div class="search-controls">
                <input type="text" id="searchInput" class="search-input" placeholder="Search for songs, artists, or albums..." />
                <button onclick="searchMusic()" class="search-btn">🔍 Search</button>
            </div>
            
            <div class="preset-artists">
                <button onclick="searchArtist('Arijit Singh')" class="preset-btn">🎤 Arijit Singh</button>
                <button onclick="searchArtist('Shreya Ghoshal')" class="preset-btn">🎤 Shreya Ghoshal</button>
                <button onclick="searchArtist('A.R. Rahman')" class="preset-btn">🎹 A.R. Rahman</button>
                <button onclick="searchArtist('KK')" class="preset-btn">🎤 KK</button>
                <button onclick="searchArtist('Sid Sriram')" class="preset-btn">🎤 Sid Sriram</button>
            </div>
        </div>

        <div class="main-content">
            <div class="music-section">
                <div id="artistInfo"></div>
                <div id="songsContainer" class="songs-grid"></div>
            </div>

            <div class="player-section">
                <div class="player">
                    <div class="audio-visualizer" id="visualizer"></div>
                    
                    <div class="now-playing">
                        <img id="currentSongImage" src="https://via.placeholder.com/200x200?text=No+Song" alt="Current Song">
                        <h3 id="currentSongTitle">Select a song to play</h3>
                        <p id="currentSongArtist">Artist</p>
                    </div>

                    <div class="player-controls">
                        <button class="control-btn" onclick="previousSong()">⏮️</button>
                        <button class="control-btn play-pause" id="playPauseBtn" onclick="togglePlayPause()">▶️</button>
                        <button class="control-btn" onclick="nextSong()">⏭️</button>
                        <button class="control-btn" onclick="toggleRepeat()" id="repeatBtn">🔁</button>
                        <button class="control-btn" onclick="toggleShuffle()" id="shuffleBtn">🔀</button>
                    </div>

                    <div class="progress-section">
                        <div class="progress-bar" onclick="seekTo(event)">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="time-display">
                            <span id="currentTime">0:00</span>
                            <span id="totalTime">0:00</span>
                        </div>
                    </div>

                    <div class="volume-section">
                        <span>🔊</span>
                        <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="70" oninput="setVolume(this.value)">
                        <span id="volumeDisplay">70%</span>
                    </div>
                </div>

                <div class="lyrics-section">
                    <h4>📝 Lyrics</h4>
                    <div class="lyrics-content" id="lyricsContent">
                        <p>Lyrics will appear here when a song is playing...</p>
                    </div>
                </div>

                <div class="queue-section">
                    <h4>🎵 Queue</h4>
                    <div class="queue-list" id="queueList"></div>
                </div>
            </div>
        </div>
    </div>

    <audio id="audioPlayer" preload="metadata"></audio>

    <script>
        // Global variables
        let currentPlaylist = [];
        let currentSongIndex = 0;
        let isPlaying = false;
        let isRepeat = false;
        let isShuffle = false;
        let audioPlayer = document.getElementById('audioPlayer');
        let currentSongData = null;

        // Initialize player
        function initializePlayer() {
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('ended', handleSongEnd);
            audioPlayer.addEventListener('loadedmetadata', updateDuration);
            audioPlayer.addEventListener('error', handleAudioError);
            
            // Create visualizer bars
            createVisualizer();
            
            // Set initial volume
            audioPlayer.volume = 0.7;
        }

        // Create audio visualizer
        function createVisualizer() {
            const visualizer = document.getElementById('visualizer');
            for (let i = 0; i < 20; i++) {
                const bar = document.createElement('div');
                bar.className = 'visualizer-bar';
                bar.style.animationDelay = `${i * 0.1}s`;
                bar.style.animationDuration = `${0.5 + Math.random() * 0.5}s`;
                visualizer.appendChild(bar);
            }
        }

        // Search functionality
        async function searchMusic() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;
            
            await searchSongs(query);
        }

        async function searchArtist(artist) {
            document.getElementById('searchInput').value = artist;
            await searchSongs(artist);
        }

        // Enhanced search with multiple API endpoints
        async function searchSongs(query) {
            const container = document.getElementById('songsContainer');
            const artistInfo = document.getElementById('artistInfo');
            
            container.innerHTML = '<div class="loading">🎵 Searching for music...</div>';
            artistInfo.innerHTML = '';

            try {
                console.log('Searching for:', query);
                
                // Try multiple API endpoints
                const apiEndpoints = [
                    `https://jiosavan-api-with-playlist.vercel.app/api/search/songs?query=${encodeURIComponent(query)}&limit=20`,
                    `https://jiosavan-api-with-playlist.vercel.app/api/search?query=${encodeURIComponent(query)}&limit=20`,
                    `https://saavn.dev/api/search/songs?query=${encodeURIComponent(query)}&limit=20`
                ];

                let searchData = null;
                let successfulEndpoint = null;

                for (const endpoint of apiEndpoints) {
                    try {
                        console.log('Trying endpoint:', endpoint);
                        const response = await fetch(endpoint);
                        const data = await response.json();
                        console.log('API Response:', data);
                        
                        // Check different response formats
                        if (data.success && data.data) {
                            if (data.data.songs && Array.isArray(data.data.songs)) {
                                searchData = data;
                                successfulEndpoint = endpoint;
                                break;
                            } else if (data.data.results && Array.isArray(data.data.results)) {
                                searchData = { success: true, data: { songs: data.data.results } };
                                successfulEndpoint = endpoint;
                                break;
                            } else if (Array.isArray(data.data)) {
                                searchData = { success: true, data: { songs: data.data } };
                                successfulEndpoint = endpoint;
                                break;
                            }
                        } else if (data.status === "Success" && data.data && Array.isArray(data.data)) {
                            searchData = { success: true, data: { songs: data.data } };
                            successfulEndpoint = endpoint;
                            break;
                        } else if (Array.isArray(data)) {
                            searchData = { success: true, data: { songs: data } };
                            successfulEndpoint = endpoint;
                            break;
                        }
                    } catch (error) {
                        console.log(`Endpoint ${endpoint} failed:`, error);
                        continue;
                    }
                }

                if (!searchData) {
                    throw new Error('All API endpoints failed or returned invalid data');
                }

                console.log('Using endpoint:', successfulEndpoint);
                
                const songs = searchData.data.songs || [];
                if (songs.length === 0) {
                    container.innerHTML = '<div class="error">No songs found. Try a different search term.</div>';
                    return;
                }

                console.log('Found songs:', songs.length);
                console.log('First song sample:', songs[0]);

                // Process songs to ensure consistent format
                const processedSongs = songs.map(song => ({
                    ...song,
                    id: song.id || song.videoId || Date.now().toString(),
                    title: song.name || song.title || 'Unknown Title',
                    image: processImageArray(song.image),
                    artists: processArtists(song),
                    album: processAlbum(song),
                    downloadUrl: song.downloadUrl || song.download_url || [],
                    duration: song.duration || 0,
                    year: song.year || song.releaseDate || ''
                }));

                currentPlaylist = processedSongs;
                displaySongs(processedSongs);
                
            } catch (error) {
                console.error('Search error:', error);
                container.innerHTML = `
                    <div class="error">
                        ❌ Search failed: ${error.message}<br>
                        <small>This might be due to API changes or network issues</small><br>
                        <button onclick="tryAlternativeSearch('${query}')" style="margin-top: 10px; padding: 8px 16px; border: none; border-radius: 5px; background: #ff6b6b; color: white; cursor: pointer;">
                            Try Alternative Search
                        </button>
                        <button onclick="location.reload()" style="margin-top: 10px; margin-left: 10px; padding: 8px 16px; border: none; border-radius: 5px; background: #667eea; color: white; cursor: pointer;">
                            Refresh Page
                        </button>
                    </div>
                `;
            }
        }

        // Alternative search using different approach
        async function tryAlternativeSearch(query) {
            const container = document.getElementById('songsContainer');
            container.innerHTML = '<div class="loading">🔍 Trying alternative search...</div>';

            try {
                // Try a different API structure
                const response = await fetch(`https://jiosaavn-api.vercel.app/search?query=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                console.log('Alternative API response:', data);
                
                let songs = [];
                if (data.results && data.results.songs) {
                    songs = data.results.songs;
                } else if (data.songs) {
                    songs = data.songs;
                } else if (Array.isArray(data)) {
                    songs = data;
                }

                if (songs.length === 0) {
                    throw new Error('No songs found in alternative search');
                }

                const processedSongs = songs.map(song => ({
                    ...song,
                    id: song.id || song.perma_url || Date.now().toString(),
                    title: song.song || song.title || song.name || 'Unknown Title',
                    image: processImageArray(song.image),
                    artists: processArtists(song),
                    album: processAlbum(song),
                    downloadUrl: song.media_preview_url ? [{ quality: '96kbps', link: song.media_preview_url }] : [],
                    duration: song.duration || 0,
                    year: song.year || ''
                }));

                currentPlaylist = processedSongs;
                displaySongs(processedSongs);

            } catch (error) {
                console.error('Alternative search failed:', error);
                container.innerHTML = `
                    <div class="error">
                        ❌ All search methods failed<br>
                        <small>The music service might be temporarily unavailable</small><br>
                        <button onclick="loadSampleSongs()" style="margin-top: 10px; padding: 8px 16px; border: none; border-radius: 5px; background: #667eea; color: white; cursor: pointer;">
                            Load Sample Songs
                        </button>
                    </div>
                `;
            }
        }

        // Load sample songs for demo
        function loadSampleSongs() {
            const sampleSongs = [
                {
                    id: 'sample1',
                    title: 'Sample Song 1',
                    artists: { primary: [{ name: 'Sample Artist' }] },
                    image: [{ quality: '150x150', url: 'https://via.placeholder.com/150x150?text=Sample+1' }],
                    album: 'Sample Album',
                    downloadUrl: [],
                    duration: 180,
                    year: '2023'
                },
                {
                    id: 'sample2',
                    title: 'Sample Song 2',
                    artists: { primary: [{ name: 'Sample Artist 2' }] },
                    image: [{ quality: '150x150', url: 'https://via.placeholder.com/150x150?text=Sample+2' }],
                    album: 'Sample Album 2',
                    downloadUrl: [],
                    duration: 200,
                    year: '2023'
                }
            ];

            currentPlaylist = sampleSongs;
            displaySongs(sampleSongs);
            
            document.getElementById('songsContainer').innerHTML += `
                <div style="text-align: center; margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                    <p>⚠️ These are sample songs for demonstration.</p>
                    <p>Real music playback requires a working API connection.</p>
                </div>
            `;
        }

        // Helper functions for processing API responses
        function processImageArray(image) {
            if (Array.isArray(image)) {
                return image;
            } else if (typeof image === 'string') {
                return [{ quality: '150x150', url: image }];
            } else if (image && image.url) {
                return [{ quality: '150x150', url: image.url }];
            }
            return [{ quality: '150x150', url: 'https://via.placeholder.com/150x150?text=♪' }];
        }

        function processArtists(song) {
            if (song.artists && song.artists.primary && Array.isArray(song.artists.primary)) {
                return song.artists;
            } else if (song.primaryArtists) {
                return { primary: [{ name: song.primaryArtists }] };
            } else if (song.artist) {
                return { primary: [{ name: song.artist }] };
            } else if (song.singers) {
                return { primary: [{ name: song.singers }] };
            }
            return { primary: [{ name: 'Unknown Artist' }] };
        }

        function processAlbum(song) {
            if (song.album && typeof song.album === 'object') {
                return song.album;
            } else if (song.album) {
                return { name: song.album };
            }
            return { name: 'Unknown Album' };
        }

        // Display songs with enhanced error handling
        function displaySongs(songs) {
            const container = document.getElementById('songsContainer');
            
            if (!songs || songs.length === 0) {
                container.innerHTML = '<div class="error">No songs available to display.</div>';
                return;
            }
            
            container.innerHTML = songs.map((song, index) => {
                const songImage = getSongImage(song);
                const artists = getSongArtists(song);
                const album = getSongAlbum(song);
                const title = song.title || 'Unknown Title';
                const duration = song.duration ? formatTime(song.duration) : '';
                const year = song.year ? `(${song.year})` : '';
                
                return `
                    <div class="song-card" onclick="playSong(${index})" data-song-index="${index}">
                        <img src="${songImage}" alt="${title}" onerror="this.src='https://via.placeholder.com/60x60?text=♪'">
                        <div class="song-info">
                            <h4 title="${title}">${title}</h4>
                            <p title="Artist: ${artists}">🎤 ${artists}</p>
                            <p title="Album: ${album}">💿 ${album} ${year}</p>
                            ${duration ? `<p>⏱️ ${duration}</p>` : ''}
                        </div>
                        <button class="play-btn" onclick="event.stopPropagation(); playSong(${index})" title="Play Song">▶️</button>
                    </div>
                `;
            }).join('');
        }
        
        // Helper function to get song image
        function getSongImage(song) {
            if (song.image && Array.isArray(song.image)) {
                const image = song.image.find(img => img.quality === '150x150') ||
                             song.image.find(img => img.quality === '500x500') ||
                             song.image.find(img => img.quality === '50x50') ||
                             song.image[0];
                return image?.url || 'https://via.placeholder.com/60x60?text=♪';
            }
            return song.image || 'https://via.placeholder.com/60x60?text=♪';
        }
        
        // Helper function to get song artists
        function getSongArtists(song) {
            if (song.artists?.primary && Array.isArray(song.artists.primary)) {
                return song.artists.primary.map(artist => artist.name).join(', ');
            }
            if (song.artists && typeof song.artists === 'string') {
                return song.artists;
            }
            if (song.primaryArtists) {
                return song.primaryArtists;
            }
            if (song.artist) {
                return song.artist;
            }
            return 'Unknown Artist';
        }
        
        // Helper function to get song album
        function getSongAlbum(song) {
            if (song.album?.name) {
                return song.album.name;
            }
            if (song.album && typeof song.album === 'string') {
                return song.album;
            }
            return 'Unknown Album';
        }

        // Play song with enhanced error handling
        async function playSong(index) {
            if (!currentPlaylist[index]) return;
            
            currentSongIndex = index;
            currentSongData = currentPlaylist[index];
            
            // Update UI immediately
            updateNowPlaying();
            updateActiveCard();
            
            // Show loading state
            document.getElementById('lyricsContent').innerHTML = '<div class="loading">🎵 Loading song...</div>';
            
            try {
                const streamUrl = await getStreamingUrl(currentSongData);
                console.log('Stream URL obtained:', streamUrl);
                
                if (streamUrl) {
                    // Stop current playback
                    audioPlayer.pause();
                    audioPlayer.currentTime = 0;
                    
                    // Set new source
                    audioPlayer.src = streamUrl;
                    
                    // Try to load and play
                    try {
                        await audioPlayer.load();
                        await audioPlayer.play();
                        isPlaying = true;
                        updatePlayPauseButton();
                        
                        // Load lyrics after successful playback
                        loadLyrics(currentSongData);
                        updateQueue();
                        
                    } catch (playError) {
                        console.error('Playback failed:', playError);
                        handlePlaybackError();
                    }
                } else {
                    throw new Error('No streaming URL available');
                }
            } catch (error) {
                console.error('Play error:', error);
                handlePlaybackError();
            }
        }
        
        // Handle playback errors
        function handlePlaybackError() {
            document.getElementById('lyricsContent').innerHTML = `
                <div class="error">
                    ❌ Unable to play this song<br>
                    <small>This might be due to licensing restrictions or the song being unavailable</small><br>
                    <button onclick="nextSong()" style="margin-top: 10px; padding: 8px 16px; border: none; border-radius: 5px; background: #ff6b6b; color: white; cursor: pointer;">
                        Try Next Song
                    </button>
                </div>
            `;
            
            // Try next song automatically after 3 seconds
            setTimeout(() => {
                if (!isPlaying && currentPlaylist.length > 1) {
                    console.log('Auto-skipping to next song due to playback error');
                    nextSong();
                }
            }, 3000);
        }

        // Get streaming URL with multiple fallback methods
        async function getStreamingUrl(song) {
            try {
                console.log('Getting streaming URL for:', song.title);
                console.log('Song data:', song);
                
                let streamUrl = null;
                
                // Method 1: Check if song already has downloadUrl from API response
                if (song.downloadUrl && Array.isArray(song.downloadUrl)) {
                    console.log('Found downloadUrl array in song data');
                    const qualityPriority = ['320kbps', '160kbps', '96kbps', '48kbps', '12kbps'];
                    
                    for (const quality of qualityPriority) {
                        const urlObj = song.downloadUrl.find(url => url.quality === quality);
                        if (urlObj && (urlObj.url || urlObj.link)) {
                            streamUrl = urlObj.url || urlObj.link;
                            console.log(`Using ${quality} quality:`, streamUrl);
                            break;
                        }
                    }
                }
                
                // Method 2: Try to fetch detailed song data if we have song ID
                if (!streamUrl && song.id && song.id !== 'sample1' && song.id !== 'sample2') {
                    console.log('Fetching detailed song data for ID:', song.id);
                    try {
                        const endpoints = [
                            `https://jiosavan-api-with-playlist.vercel.app/api/songs/${song.id}`,
                            `https://saavn.dev/api/songs?id=${song.id}`,
                            `https://jiosaavn-api.vercel.app/song?id=${song.id}`
                        ];

                        for (const endpoint of endpoints) {
                            try {
                                const response = await fetch(endpoint);
                                const detailedData = await response.json();
                                
                                let downloadUrls = [];
                                if (detailedData.success && detailedData.data && detailedData.data.downloadUrl) {
                                    downloadUrls = detailedData.data.downloadUrl;
                                } else if (detailedData.download_url) {
                                    downloadUrls = detailedData.download_url;
                                } else if (detailedData.media_preview_url) {
                                    downloadUrls = [{ quality: '96kbps', url: detailedData.media_preview_url }];
                                }
                                
                                if (downloadUrls.length > 0) {
                                    const qualityPriority = ['320kbps', '160kbps', '96kbps', '48kbps', '12kbps'];
                                    
                                    for (const quality of qualityPriority) {
                                        const urlObj = downloadUrls.find(url => url.quality === quality);
                                        if (urlObj && (urlObj.url || urlObj.link)) {
                                            streamUrl = urlObj.url || urlObj.link;
                                            console.log(`Using ${quality} quality from detailed data:`, streamUrl);
                                            break;
                                        }
                                    }
                                    
                                    if (streamUrl) break;
                                }
                            } catch (error) {
                                console.log(`Endpoint ${endpoint} failed:`, error);
                                continue;
                            }
                        }
                    } catch (error) {
                        console.log('Failed to get detailed song data:', error);
                    }
                }
                
                // Method 3: Check for other URL fields as fallback
                if (!streamUrl) {
                    streamUrl = song.media_preview_url || song.preview_url || song.url;
                    console.log('Using fallback URL:', streamUrl);
                }
                
                // Method 4: For sample songs, use a demo audio file
                if (!streamUrl && (song.id === 'sample1' || song.id === 'sample2')) {
                    // Use a short demo audio file for samples
                    streamUrl = 'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav';
                    console.log('Using demo audio for sample song');
                }
                
                // Validate the URL before returning
                if (streamUrl) {
                    console.log('Final streaming URL:', streamUrl);
                    return streamUrl;
                }
                
                console.log('No valid streaming URL found');
                return null;
                
            } catch (error) {
                console.error('Error getting streaming URL:', error);
                return null;
            }
        }

        // Load lyrics with enhanced error handling
        async function loadLyrics(song) {
            const lyricsContent = document.getElementById('lyricsContent');
            lyricsContent.innerHTML = '<div class="loading">📝 Loading lyrics...</div>';
            
            try {
                const artist = getSongArtists(song).split(',')[0].trim();
                const title = song.title || song.name || '';
                
                if (!title || title === 'Unknown Title') {
                    lyricsContent.innerHTML = '<p>📝 Lyrics not available for this song</p>';
                    return;
                }
                
                const response = await fetch(`https://api.lyrics.ovh/v1/${encodeURIComponent(artist)}/${encodeURIComponent(title)}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.lyrics) {
                        lyricsContent.innerHTML = `<div class="lyrics-content">${data.lyrics.replace(/\n/g, '<br>')}</div>`;
                        return;
                    }
                }
                
                // Try alternative lyrics API
                const altResponse = await fetch(`https://lrclib.net/api/search?artist_name=${encodeURIComponent(artist)}&track_name=${encodeURIComponent(title)}`);
                const altData = await altResponse.json();
                
                if (altData && altData.length > 0 && (altData[0].syncedLyrics || altData[0].plainLyrics)) {
                    const lyrics = altData[0].syncedLyrics || altData[0].plainLyrics;
                    lyricsContent.innerHTML = `<div class="lyrics-content">${lyrics.replace(/\n/g, '<br>')}</div>`;
                } else {
                    lyricsContent.innerHTML = '<p>📝 Lyrics not available for this song</p>';
                }
            } catch (error) {
                console.error('Lyrics error:', error);
                lyricsContent.innerHTML = '<p>📝 Lyrics not available for this song</p>';
            }
        }

        // Update now playing display
        function updateNowPlaying() {
            if (!currentSongData) return;
            
            const songImage = getSongImage(currentSongData);
            const artists = getSongArtists(currentSongData);
            const title = currentSongData.title || 'Unknown Title';
            
            document.getElementById('currentSongImage').src = songImage;
            document.getElementById('currentSongImage').onerror = function() {
                this.src = 'https://via.placeholder.com/200x200?text=♪';
            };
            document.getElementById('currentSongTitle').textContent = title;
            document.getElementById('currentSongTitle').title = title;
            document.getElementById('currentSongArtist').textContent = artists;
            document.getElementById('currentSongArtist').title = artists;
        }
        
        // Update queue display
        function updateQueue() {
            const queueList = document.getElementById('queueList');
            const nextSongs = currentPlaylist.slice(currentSongIndex + 1, currentSongIndex + 6);
            
            queueList.innerHTML = nextSongs.map((song, index) => {
                const artists = getSongArtists(song);
                const title = song.title || 'Unknown Title';
                
                return `
                    <div class="queue-item" onclick="playSong(${currentSongIndex + 1 + index})">
                        ${title} - ${artists}
                    </div>
                `;
            }).join('');
            
            if (nextSongs.length === 0) {
                queueList.innerHTML = '<div class="queue-item">Queue is empty</div>';
            }
        }

        // Update active song card
        function updateActiveCard() {
            document.querySelectorAll('.song-card').forEach((card, index) => {
                card.classList.toggle('active', index === currentSongIndex);
            });
        }

        // Player controls
        function togglePlayPause() {
            if (!currentSongData) {
                if (currentPlaylist.length > 0) {
                    playSong(0);
                }
                return;
            }
            
            if (isPlaying) {
                audioPlayer.pause();
                isPlaying = false;
            } else {
                audioPlayer.play().catch(error => {
                    console.error('Play failed:', error);
                    handlePlaybackError();
                });
                isPlaying = true;
            }
            updatePlayPauseButton();
        }

        function updatePlayPauseButton() {
            const btn = document.getElementById('playPauseBtn');
            btn.textContent = isPlaying ? '⏸️' : '▶️';
        }

        function previousSong() {
            if (currentPlaylist.length === 0) return;
            
            currentSongIndex = currentSongIndex > 0 ? currentSongIndex - 1 : currentPlaylist.length - 1;
            playSong(currentSongIndex);
        }

        function nextSong() {
            if (currentPlaylist.length === 0) return;
            
            if (isShuffle) {
                currentSongIndex = Math.floor(Math.random() * currentPlaylist.length);
            } else {
                currentSongIndex = currentSongIndex < currentPlaylist.length - 1 ? currentSongIndex + 1 : 0;
            }
            playSong(currentSongIndex);
        }

        function toggleRepeat() {
            isRepeat = !isRepeat;
            const btn = document.getElementById('repeatBtn');
            btn.style.background = isRepeat ? 'linear-gradient(45deg, #ff6b6b, #ee5a52)' : 'linear-gradient(45deg, #667eea, #764ba2)';
        }

        function toggleShuffle() {
            isShuffle = !isShuffle;
            const btn = document.getElementById('shuffleBtn');
            btn.style.background = isShuffle ? 'linear-gradient(45deg, #ff6b6b, #ee5a52)' : 'linear-gradient(45deg, #667eea, #764ba2)';
        }

        // Progress and time functions
        function updateProgress() {
            if (audioPlayer.duration) {
                const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('currentTime').textContent = formatTime(audioPlayer.currentTime);
            }
        }

        function updateDuration() {
            document.getElementById('totalTime').textContent = formatTime(audioPlayer.duration);
        }

        function seekTo(event) {
            const progressBar = event.currentTarget;
            const rect = progressBar.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            audioPlayer.currentTime = percent * audioPlayer.duration;
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // Volume control
        function setVolume(volume) {
            audioPlayer.volume = volume / 100;
            document.getElementById('volumeDisplay').textContent = volume + '%';
        }

        // Handle song end
        function handleSongEnd() {
            if (isRepeat) {
                audioPlayer.currentTime = 0;
                audioPlayer.play();
            } else {
                nextSong();
            }
        }

        // Handle audio errors
        function handleAudioError() {
            console.error('Audio playback error');
            isPlaying = false;
            updatePlayPauseButton();
            handlePlaybackError();
        }

        // Search on Enter key
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchMusic();
            }
        });

        // Initialize the player when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializePlayer();
            
            // Load default songs (Arijit Singh)
            searchArtist('Arijit Singh');
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName.toLowerCase() === 'input') return;
            
            switch(e.code) {
                case 'Space':
                    e.preventDefault();
                    togglePlayPause();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    nextSong();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    previousSong();
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    const currentVolume = parseInt(document.getElementById('volumeSlider').value);
                    const newVolumeUp = Math.min(100, currentVolume + 5);
                    document.getElementById('volumeSlider').value = newVolumeUp;
                    setVolume(newVolumeUp);
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    const currentVolumeDown = parseInt(document.getElementById('volumeSlider').value);
                    const newVolumeDown = Math.max(0, currentVolumeDown - 5);
                    document.getElementById('volumeSlider').value = newVolumeDown;
                    setVolume(newVolumeDown);
                    break;
            }
        });

        // Update visualizer animation
        function updateVisualizer() {
            if (!isPlaying) return;
            
            const bars = document.querySelectorAll('.visualizer-bar');
            bars.forEach(bar => {
                const height = Math.random() * 35 + 5;
                bar.style.height = height + 'px';
            });
        }

        // Update visualizer when playing
        setInterval(updateVisualizer, 100);

        // Network status monitoring
        function showNetworkStatus(isOnline) {
            const existing = document.getElementById('networkStatus');
            if (existing) existing.remove();
            
            if (!isOnline) {
                const status = document.createElement('div');
                status.id = 'networkStatus';
                status.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    background: #ff6b6b;
                    color: white;
                    padding: 10px 15px;
                    border-radius: 5px;
                    font-size: 14px;
                    z-index: 1000;
                `;
                status.innerHTML = '🔴 Network issues detected';
                document.body.appendChild(status);
            }
        }
        
        window.addEventListener('online', () => {
            showNetworkStatus(true);
            console.log('Network connection restored');
        });
        
        window.addEventListener('offline', () => {
            showNetworkStatus(false);
            console.log('Network connection lost');
        });

        // Error recovery mechanism
        function attemptRecovery() {
            console.log('Attempting to recover from errors...');
            
            // Clear any error states
            const container = document.getElementById('songsContainer');
            if (container.innerHTML.includes('Search failed')) {
                container.innerHTML = '<div class="loading">🔄 Retrying search...</div>';
                setTimeout(() => {
                    searchArtist('Arijit Singh');
                }, 1000);
            }
        }

        // Auto-recovery on network restoration
        window.addEventListener('online', attemptRecovery);

        console.log('JioSaavn Music Player initialized successfully!');
    </script>
</body>
</html>
